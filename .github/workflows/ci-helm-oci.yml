name: Publish Helm Charts (OCI to GHCR)

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      chart:
        description: "Chart directory under charts/ to publish (e.g., todo-vue) or 'all'"
        required: true
        default: "all"

permissions:
  contents: read
  packages: write

concurrency:
  group: helm-oci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect:
    name: Detect charts to publish
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_charts: ${{ steps.matrix.outputs.has_charts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build chart matrix
        id: matrix
        shell: bash
        run: |
          set -euo pipefail

          echo "event_name=${GITHUB_EVENT_NAME}"
          echo "ref=${GITHUB_REF}"

          get_all_charts() {
            if [[ ! -d "charts" ]]; then
              return 0
            fi
            find charts -mindepth 1 -maxdepth 1 -type d -print0 \
              | xargs -0 -r -I{} basename "{}" \
              | sort -u
          }

          chart_dirs=""

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            input_chart="${{ github.event.inputs.chart || 'all' }}"
            if [[ "${input_chart}" == "all" ]]; then
              chart_dirs="$(get_all_charts || true)"
            else
              chart_dirs="${input_chart}"
            fi
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # Tag-based release publishes all charts.
            chart_dirs="$(get_all_charts || true)"
          else
            # Push to main: publish only changed charts.
            base_sha="${{ github.event.before }}"
            head_sha="${GITHUB_SHA}"

            # Handle edge cases like initial commit where before is all zeros.
            # In that case, diff against the empty tree so all added charts are detected.
            if [[ "${base_sha}" == "0000000000000000000000000000000000000000" ]]; then
              base_sha="$(git hash-object -t tree /dev/null)"
            fi

            changed_files="$(git diff --name-only "${base_sha}" "${head_sha}" -- 'charts/**' || true)"
            chart_dirs="$(echo "${changed_files}" \
              | awk -F/ '/^charts\// && NF>=2 {print $2}' \
              | sort -u)"
          fi

          # Normalize: remove empty lines
          chart_dirs="$(echo "${chart_dirs}" | sed '/^$/d' || true)"

          # Convert to JSON array for matrix (bash only)
          matrix_json="[]"
          if [[ -n "${chart_dirs}" ]]; then
            mapfile -t _charts <<< "${chart_dirs}"
            matrix_json="["
            first=1
            for c in "${_charts[@]}"; do
              # Escape for JSON
              esc="${c//\\/\\\\}"
              esc="${esc//\"/\\\"}"
              if [[ ${first} -eq 1 ]]; then
                first=0
              else
                matrix_json+=","
              fi
              matrix_json+="\"${esc}\""
            done
            matrix_json+="]"
          fi

          if [[ "${matrix_json}" == "[]" ]]; then
            echo "No charts to publish."
            echo "has_charts=false" >> "${GITHUB_OUTPUT}"
          else
            echo "Charts to publish:"; echo "${chart_dirs}"
            echo "has_charts=true" >> "${GITHUB_OUTPUT}"
          fi

          echo "matrix=${matrix_json}" >> "${GITHUB_OUTPUT}"

  publish:
    name: Lint, package, and push
    needs: detect
    if: needs.detect.outputs.has_charts == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chart_dir: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm version
        run: helm version

      - name: Login to GHCR (OCI)
        shell: bash
        run: |
          set -euo pipefail
          echo "${GITHUB_TOKEN}" | helm registry login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate chart metadata (OCI source annotation)
        shell: bash
        run: |
          set -euo pipefail
          chart_path="charts/${{ matrix.chart_dir }}"

          if [[ ! -f "${chart_path}/Chart.yaml" ]]; then
            echo "Missing Chart.yaml in ${chart_path}" >&2
            exit 1
          fi

          # Require OCI source annotation in Chart.yaml.
          if ! grep -q "org.opencontainers.image.source" "${chart_path}/Chart.yaml"; then
            echo "Missing required annotation 'org.opencontainers.image.source' in ${chart_path}/Chart.yaml" >&2
            exit 1
          fi

      - name: Helm dependency build (only when dependencies are declared)
        shell: bash
        run: |
          set -euo pipefail

          chart_path="charts/${{ matrix.chart_dir }}"

          if grep -Eq '^\s*dependencies\s*:' "${chart_path}/Chart.yaml"; then
            echo "dependencies declared; running helm dependency build"
            helm dependency build "${chart_path}"
          else
            echo "no dependencies declared; skipping helm dependency build"
          fi

      - name: Helm lint
        shell: bash
        run: |
          set -euo pipefail
          helm lint "charts/${{ matrix.chart_dir }}"

      - name: Install kubeval
        shell: bash
        run: |
          set -euo pipefail

          KUBEVAL_VERSION="0.16.1"
          curl -sSL -o /tmp/kubeval.tar.gz "https://github.com/instrumenta/kubeval/releases/download/v${KUBEVAL_VERSION}/kubeval-linux-amd64.tar.gz"
          tar -C /tmp -xzf /tmp/kubeval.tar.gz
          sudo mv /tmp/kubeval /usr/local/bin/kubeval
          kubeval --version

      - name: Helm template + kubeval (render checks, no cluster)
        shell: bash
        run: |
          set -euo pipefail

          chart_path="charts/${{ matrix.chart_dir }}"
          release="render-${{ matrix.chart_dir }}"

          # Render with chart defaults and validate known Kubernetes resource schemas.
          # CRDs (for example, OpenShift Route) are ignored.
          helm template "${release}" "${chart_path}" --namespace default \
            | kubeval --strict --ignore-missing-schemas

      - name: Package and push (OCI path, lowercase)
        shell: bash
        run: |
          set -euo pipefail

          chart_path="charts/${{ matrix.chart_dir }}"
          mkdir -p dist

          chart_name="$(helm show chart "${chart_path}" | awk -F': ' '$1=="name"{print $2}')"
          if [[ -z "${chart_name}" ]]; then
            echo "Unable to determine chart name for ${chart_path}" >&2
            exit 1
          fi

          pkg_path="$(helm package "${chart_path}" --destination dist | sed -n 's/^.*saved it to: //p')"
          if [[ -z "${pkg_path}" || ! -f "${pkg_path}" ]]; then
            echo "Packaging failed or artifact missing for ${chart_path}" >&2
            exit 1
          fi

          owner_lc="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          repo_lc="$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')"

          # NOTE:
          # `helm push <chart.tgz> oci://<host>/<namespace>/<repo>` will create the final artifact under:
          #   <host>/<namespace>/<repo>/<chart_name>:<chart_version>
          # so do NOT append the chart name here.
          target="oci://ghcr.io/${owner_lc}/${repo_lc}"
          echo "Pushing ${pkg_path} -> ${target}"

          helm push "${pkg_path}" "${target}"
        env:
          HELM_EXPERIMENTAL_OCI: 1
